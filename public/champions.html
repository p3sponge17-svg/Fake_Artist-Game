<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CHAMPIONS — Fake Artist</title>
  <link rel="stylesheet" href="/styles.css">
  <style>
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;}
    body {
      background: center/cover no-repeat fixed;
      color: #fff;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
      min-height:100vh;
    }
    .panel {
      background: rgba(0,0,0,0.5);
      padding:28px;
      border-radius:14px;
      backdrop-filter: blur(6px);
      max-width:1100px;
      width:100%;
      box-shadow: 0 18px 40px rgba(0,0,0,0.6);
      border:1px solid rgba(255,255,255,0.04);
    }
    h1.main { font-size:48px; margin:0; letter-spacing:0.06em; color:#ffd; text-align:center; }
    h2.sub { font-size:18px; color:#ddd; text-align:center; margin-top:8px; font-weight:700; }
    .champions-list { display:flex; gap:20px; margin-top:20px; flex-wrap:wrap; justify-content:center; }
    .champ-card {
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
      border-radius:12px;
      padding:16px 22px;
      text-align:center;
      min-width:240px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.45);
      border:1px solid rgba(255,255,255,0.03);
    }
    .champ-name { font-size:28px; font-weight:900; margin-bottom:6px; color:#00d1a6; }
    .champ-score { font-size:20px; color:#fff; }
    .history { margin-top:18px; color:#eee; max-height:200px; overflow:auto; padding:8px; border-radius:8px; background: rgba(255,255,255,0.02); }
    .controls { margin-top:20px; display:flex; justify-content:center; gap:12px; }
    .btn { padding:10px 14px; border-radius:10px; border:none; cursor:pointer; font-weight:800; }
    .btn-primary { background:linear-gradient(180deg,#00d1a6,#008f74); color:#05221d; }
    .btn-ghost { background:transparent; border:1px solid rgba(255,255,255,0.06); color:#fff; }
    .scores-table { margin-top:16px; width:100%; border-collapse:collapse; color:#fff; }
    .scores-table th, .scores-table td { padding:8px 10px; text-align:left; border-top:1px solid rgba(255,255,255,0.03); }
    @media (max-width:780px){ h1.main{font-size:34px} .champ-card{min-width:150px} }
  </style>
</head>
<body id="championsBody">
  <div class="panel">
    <h1 class="main">CHAMPIONS</h1>
    <h2 class="sub">HCA SERVICE DESK TEAM-BUILDING EXERCISE</h2>

    <div id="championDisplay" style="margin-top:18px; text-align:center;">
      <!-- Champion names will be inserted here -->
    </div>

    <div class="champions-list" id="championsList">
      <!-- Individual champion cards (if multiple champions) -->
    </div>

    <table class="scores-table" id="scoresTable" style="margin-top:20px;">
      <thead><tr><th>Player</th><th style="text-align:right">Score</th><th style="text-align:right">Champion Titles</th></tr></thead>
      <tbody id="scoresBody"></tbody>
    </table>

    <div class="history" id="historyBlock">
      <strong>Previous Champions</strong>
      <div id="historyList"></div>
    </div>

    <div class="controls">
      <button id="startNextBtn" class="btn btn-primary">Start the Next Game (Reset Scores)</button>
      <button id="backLobbyBtn" class="btn btn-ghost">Return to Lobby</button>
    </div>
  </div>

<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();

  (function setBg(){
    const url = '/assets/victory-bg.gif';
    const img = new Image();
    img.onload = () => { document.body.style.backgroundImage = `url('${url}')`; };
    img.onerror = () => { /* no wallpaper found */ };
    img.src = url;
  })();

  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }

  // Robust renderer that accepts either id-keyed or name-keyed scores.
  function renderChampionsData(payload) {
    const championTitles = payload.championTitles || {};
    const history = payload.history || [];
    const scores = payload.scores || {};       // may be id-keyed (id -> number) or name-keyed (name -> number)
    const players = payload.players || {};     // expected to be object keyed by id OR array of player objects

    // Normalize players into array and build maps by id and by name
    const playerArray = Array.isArray(players) ? players.slice() : Object.values(players || {});
    const playersById = {};
    const playersByName = {};
    playerArray.forEach(p => {
      if (!p) return;
      playersById[p.id] = p;
      if (p.name) playersByName[p.name] = p;
    });

    // Helper to read a score for a player (works for id-keyed and name-keyed scores)
    function getScoreForPlayer(p) {
      if (!p) return 0;
      if (scores[p.id] !== undefined) return scores[p.id];
      if (scores[p.name] !== undefined) return scores[p.name];
      const norm = (p.name || '').trim();
      if (scores[norm] !== undefined) return scores[norm];
      return 0;
    }

    // Show champion(s) — latest history item (if available)
    const latest = history[0] || null;
    const champDisplay = document.getElementById('championDisplay');
    const champsListEl = document.getElementById('championsList');
    champDisplay.innerHTML = '';
    champsListEl.innerHTML = '';

    if (latest && Array.isArray(latest.champions) && latest.champions.length) {
      const text = latest.champions.join(', ');
      champDisplay.innerHTML = `<div style="font-size:22px;color:#ffd">Champion(s): <strong style="font-size:28px">${escapeHtml(text)}</strong></div>`;
      latest.champions.forEach(name => {
        const div = document.createElement('div');
        div.className = 'champ-card';
        div.innerHTML = `<div class="champ-name">${escapeHtml(name)}</div>
                         <div class="champ-score">${(championTitles[name]||0)} title(s)</div>`;
        champsListEl.appendChild(div);
      });
    } else {
      champDisplay.innerHTML = `<div style="font-size:20px;color:#fff">No recent champions</div>`;
    }

    // Build rows
    const rows = [];

    // 1) If scores looks id-keyed (has any known id keys), use that authoritative list
    const someIdKey = playerArray.length > 0 && Object.keys(scores).some(k => playersById[k]);
    if (someIdKey) {
      // iterate players known by id (ensures we have name/color)
      playerArray.forEach(p => {
        rows.push({
          name: p.name,
          color: p.color || '#999',
          score: getScoreForPlayer(p),
          titles: (championTitles[p.name] || 0)
        });
      });
    } else {
      // If scores look name-keyed, iterate scores keys and map to players if possible
      const seenNames = new Set();
      for (const nameKey in scores) {
        const scoreVal = scores[nameKey] || 0;
        const p = playersByName[nameKey];
        rows.push({
          name: nameKey,
          color: p ? p.color : '#999',
          score: scoreVal,
          titles: (championTitles[nameKey] || 0)
        });
        seenNames.add(nameKey);
      }
      // include any connected players not present in scores
      playerArray.forEach(p => {
        if (!seenNames.has(p.name)) {
          rows.push({
            name: p.name,
            color: p.color || '#fff',
            score: getScoreForPlayer(p),
            titles: (championTitles[p.name] || 0)
          });
        }
      });
    }

    // Sort descending
    rows.sort((a,b) => b.score - a.score);

    // Render table body
    const tbody = document.getElementById('scoresBody');
    tbody.innerHTML = '';
    for (const r of rows) {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td><div style="display:flex;align-items:center;gap:10px;"><div style="width:14px;height:14px;background:${r.color};border-radius:4px;"></div>${escapeHtml(r.name)}</div></td>
                      <td style="text-align:right">${r.score}</td>
                      <td style="text-align:right">${r.titles}</td>`;
      tbody.appendChild(tr);
    }

    // history list
    const historyList = document.getElementById('historyList');
    historyList.innerHTML = '';
    if (history.length === 0) {
      historyList.innerHTML = '<div style="color:#ccc;margin-top:8px">No champions yet.</div>';
    } else {
      history.forEach(h => {
        const when = new Date(h.time).toLocaleString();
        const entry = document.createElement('div');
        entry.style.marginTop = '8px';
        entry.innerHTML = `<div><strong>${escapeHtml((h.champions||[]).join(', '))}</strong> — ${when}</div>`;
        historyList.appendChild(entry);
      });
    }
  }

  // Request champions data on load
  socket.emit('getChampions');

  socket.on('championsData', (payload) => {
    renderChampionsData(payload);
  });

  // In case the server broadcasts 'victory' afterwards while page open
  socket.on('victory', (data) => {
    socket.emit('getChampions');
  });

  document.getElementById('backLobbyBtn').addEventListener('click', () => {
    window.location.href = '/lobby';
  });

  document.getElementById('startNextBtn').addEventListener('click', () => {
    socket.emit('resetScoresAndStart', { resetChampionTitles: false });
    window.location.href = '/lobby';
  });
</script>
</body>
</html>